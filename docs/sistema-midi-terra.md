# Sistema MIDI Terra - Documenta√ß√£o Completa

**Data**: 16/10/2025  
**Vers√£o**: 1.0.0  
**Autor**: Terra MIDI System

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Dispositivos Suportados](#dispositivos-suportados)
4. [Instala√ß√£o e Configura√ß√£o](#instala√ß√£o-e-configura√ß√£o)
5. [Uso do Sistema](#uso-do-sistema)
6. [Integra√ß√£o com Web Audio](#integra√ß√£o-com-web-audio)
7. [Testes e Valida√ß√£o](#testes-e-valida√ß√£o)
8. [Desenvolvimento de Novos Dispositivos](#desenvolvimento-de-novos-dispositivos)
9. [Troubleshooting](#troubleshooting)

---

## üéØ Vis√£o Geral

O **Sistema MIDI Terra** √© uma arquitetura modular para integra√ß√£o de dispositivos MIDI USB da Terra Eletr√¥nica com a plataforma MusicoTerapia AI. O sistema utiliza a Web MIDI API do navegador para detectar automaticamente dispositivos conectados e rotear mensagens MIDI para handlers espec√≠ficos de cada hardware.

### Caracter√≠sticas Principais

- ‚úÖ **Auto-detec√ß√£o** de dispositivos MIDI USB
- ‚úÖ **Arquitetura modular** com device handlers independentes
- ‚úÖ **Pitch Bend com deadzone** de 2% para evitar movimentos n√£o intencionais
- ‚úÖ **Oscilosc√≥pio virtual** para visualiza√ß√£o em tempo real
- ‚úÖ **Painel de status** com informa√ß√µes de dispositivos e notas ativas
- ‚úÖ **Integra√ß√£o completa** com soundfontManager e audioEngine
- ‚úÖ **Extens√≠vel** para futuros dispositivos Terra

---

## üèóÔ∏è Arquitetura do Sistema

### Camadas da Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Web MIDI API (Browser)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       MIDIDeviceManager (Core)          ‚îÇ
‚îÇ  - Detec√ß√£o de dispositivos             ‚îÇ
‚îÇ  - Decodifica√ß√£o de mensagens           ‚îÇ
‚îÇ  - Roteamento de eventos                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇBoardBells   ‚îÇ      ‚îÇ  Device         ‚îÇ
‚îÇDevice       ‚îÇ      ‚îÇ  Templates      ‚îÇ
‚îÇ(Completo)   ‚îÇ      ‚îÇ  (4 futuros)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                      ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  soundfontManager + audioEngine       ‚îÇ
‚îÇ  - Reprodu√ß√£o de √°udio                ‚îÇ
‚îÇ  - Sele√ß√£o de instrumentos            ‚îÇ
‚îÇ  - Efeitos e processamento            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes Principais

#### 1. **MIDIDeviceManager** (`js/midi/midiDeviceManager.js`)

Gerenciador central do sistema MIDI:

- **initialize()**: Inicializa Web MIDI API e escaneia dispositivos
- **scanForDevices()**: Detecta dispositivos MIDI conectados
- **connectDevice(input)**: Cria listener para dispositivo espec√≠fico
- **handleMIDIMessage(event, input)**: Decodifica e roteia mensagens MIDI
- **createDeviceHandler(input)**: Identifica e instancia handler apropriado

#### 2. **BoardBellaDevice + Catalog** (`js/midi/devices/boardBellaDevice.js`, `js/midi/devices/boardBellaCatalog.js`)

Handler avan√ßado que une controle f√≠sico (pads + knob + LED) com um cat√°logo dedicado de 811 instrumentos.

**Destaques:**

- Extende `TerraDevice` e aplica regras de acordes/oitavas do Board Bella
- Alterna dinamicamente entre modos **MIDI** e **HID** (com `boardBellaHIDClient` opcional)
- Usa `BoardBellaCatalog` para resolver programas, favoritos, grupos e fallback offline
- Envia broadcasts MIDI/CC globais (grupo/slot) e garante *All Notes Off* na troca de modos
- Integra-se automaticamente ao `soundfontManager` / `audioEngine` quando dispon√≠veis

**Arquitetura interna:**

- `handleKnobRotation()` com acumulador incremental (threshold adaptativo)
- `handleKnobWithModifier()` interpreta teclas especiais (OITV, FAVOR, ACORDE, etc.)
- `clearAllNotes({ forceMidi })` garante libera√ß√£o segura ao alternar para HID
- `broadcastGroupSelection()` sincroniza slots com hosts externos (CC `0x53`/`0x54`)
- `emitHIDKey()` traduz notas para c√≥digos padr√£o (`Digit1` ‚Ä¶ `Digit8`)

#### 3. **BoardBellsDevice** (`js/midi/devices/boardBellsDevice.js`)

Handler completo para o dispositivo Board Bells:

**Especifica√ß√µes:**

- 8 notas mapeadas (C4 a C5: C, D, E, F, G, A, B, C2)
- 5 programas MIDI (0-4) para troca de instrumento
- Pitch Bend com deadzone de 2%
- Integra√ß√£o com soundfontManager, audioEngine, e UI

**Mensagens Suportadas:**

- **Note On/Off**: Inicia/para reprodu√ß√£o de notas
- **Program Change**: Troca instrumento (piano, violino, flauta, viol√£o, harpa)
- **Pitch Bend**: Modula altura da nota (com filtragem de margem)

#### 4. **Terra Device Templates** (`js/midi/devices/terraDevicesTemplates.js`)

Classes base para futuros dispositivos:

- **TerraDevice**: Classe base com estrutura comum
- **GiroSomDevice**: Template para sensor girosc√≥pio
- **BoardSomDevice**: Template para placa multi-sensor
- **BigKeyBoardDevice**: Template para teclado grande (12 teclas)
- **MusicalBeamDevice**: Template para feixe infravermelho

#### 5. **MIDIOscilloscope** (`js/midi/midiOscilloscope.js`)

Visualizador de pitch bend em tempo real:

- Canvas HTML5 com renderiza√ß√£o a 60 FPS
- Indicador visual de deadzone (¬±2%)
- Hist√≥rico de 200 pontos
- Cores diferenciadas para valores ativos vs deadzone

#### 6. **MIDIStatusPanel** (`js/midi/midiStatusPanel.js`)

Painel de status visual:

- Lista de dispositivos conectados
- Notas ativas por dispositivo
- Programa/instrumento atual
- Indicador de conex√£o e atividade

---

## üéπ Dispositivos Suportados

### 1. Board Bella ‚úÖ (NOVO)

**Descri√ß√£o**: Controlador h√≠brido com 8 pads capacitivos, knob incremental de alta resolu√ß√£o, LEDs status MIDI/HID e firmware otimizado para navegar pelo cat√°logo completo (811 soundfonts) sem depender de elementos extras na UI.

**Caracter√≠sticas Principais:**

- 8 pads sens√≠veis: D√ì, R√â, MI, F√Å, SOL, L√Å, SI, D√ì (oitava configur√°vel)
- Knob com leitura cont√≠nua e threshold adaptativo (detec√ß√£o de passo a cada ~15% de deslocamento)
- Combina√ß√£o tecla + knob para acionar modos especiais (oitava, grupos, favoritos, etc.)
- Cat√°logo dedicado (`BoardBellaCatalog`) com favoritos, 4 grupos x 5 slots e fallback offline
- Modo **Battery** com 3 perfis, toggle de **MIDI ‚Üî HID**, reinicializa√ß√£o r√°pida e limpeza de notas via knob
- Sa√≠da simult√¢nea para **audioEngine**, **soundfontManager** e broadcast MIDI global
- Cliente HID opcional (`window.boardBellaHIDClient`) com mapeamento padr√£o para teclas num√©ricas

**Mapeamento de Notas (padr√£o):**

| Pad | Nota MIDI | Nome | HID padr√£o |
|-----|-----------|------|------------|
| 1   | 60        | C4   | Digit1     |
| 2   | 62        | D4   | Digit2     |
| 3   | 64        | E4   | Digit3     |
| 4   | 65        | F4   | Digit4     |
| 5   | 67        | G4   | Digit5     |
| 6   | 69        | A4   | Digit6     |
| 7   | 71        | B4   | Digit7     |
| 8   | 72        | C5   | Digit8     |

**Fun√ß√µes Especiais (tecla de refer√™ncia + giro do knob):**

| Tecla pressionada | R√≥tulo impresso | A√ß√£o knob ‚Üª | A√ß√£o knob ‚Ü∫ |
|-------------------|-----------------|-------------|-------------|
| Pad 1             | `OITV`          | +1 oitava   | ‚àí1 oitava   |
| Pad 2             | `8 INSTR`       | Avan√ßa 8 instrumentos | Volta 8 instrumentos |
| Pad 3             | `1 INSTR`       | Avan√ßa 1 instrumento  | Volta 1 instrumento  |
| Pad 4             | `FAVOR`         | Pr√≥ximo favorito      | Favorito anterior    |
| Pad 5             | `ACORDE`        | Habilita acordes completos | Desabilita (nota raiz) |
| Pad 6             | `MODO BAT`      | Pr√≥ximo modo (Off ‚Üí H√≠brido ‚Üí Percussivo) | Modo anterior |
| Pad 7             | `MIDI/HID`      | Alterna para HID (envia release MIDI for√ßado) | Alterna para MIDI |
| Pad 8             | `REINIT`        | Recarrega preset inicial, zera estados | Limpa notas ativas |

> **Importante:** O hardware gerencia o modo acorde, portanto **n√£o exibir checkboxes adicionais na UI** para o Board Bella. A UI global mant√©m o toggle geral, mas o handler sobrescreve dinamicamente o estado de acordes conforme o knob.

**Integra√ß√£o com Cat√°logo:**

- **Favoritos**: 10 posi√ß√µes (configur√°veis) rotacionadas pelo knob com `FAVOR`
- **Grupos**: 4 grupos √ó 5 slots; sincronizados via CC `0x53` (grupo) e `0x54` (slot)
- **Program Change**: Broadcast apenas no modo MIDI, garantindo sincronismo com hosts externos
- **Fallback offline**: Se `soundfontManager` ou manifest n√£o estiverem dispon√≠veis, utiliza `soundfonts-manifest.json`

**Modo HID:**

- Quando ativo, envia eventos `{ type: 'key', action: 'down'/'up', code: DigitN }`
- Recebe `mode` updates via `window.boardBellaHIDClient.send({ type: 'mode', ... })`
- Notas MIDI s√£o silenciadas, mas CC cr√≠ticos (LEDs, grupo/slot) continuam sendo transmitidos
- Transi√ß√£o MIDI ‚Üí HID dispara `All Notes Off` for√ßado para evitar notas presas no host

### 2. Board Bells ‚úÖ (IMPLEMENTADO)

**Descri√ß√£o**: Placa com 8 sensores de toque capacitivo em formato de sinos.

**Caracter√≠sticas:**

- 8 notas: D√ì, R√â, MI, F√Å, SOL, L√Å, SI, D√ì (oitava superior)
- Mapeamento MIDI: Notas 60-72 (C4-C5)
- Velocity: 0-127 (normalizado para 0-1)
- Pitch Bend: ¬±8192 steps (¬±100%)
- Deadzone: 2% (¬±164 steps)

**Program Change:**

| Programa | Instrumento        | Key                 |
|----------|--------------------|---------------------|
| 0        | Piano de Cauda     | `piano_grand`       |
| 1        | Violino Ensemble   | `violin_ensemble`   |
| 2        | Flauta Concerto    | `flute_concert`     |
| 3        | Viol√£o Nylon       | `guitar_nylon`      |
| 4        | Harpa Orquestral   | `harp_orchestral`   |

### 3. Giro Som üìù (TEMPLATE)

**Descri√ß√£o**: Dispositivo com sensor girosc√≥pio para controle por movimento.

**Planejamento:**

- Rota√ß√£o: Controle de par√¢metros cont√≠nuos
- Velocidade: Intensity/velocity
- Eixos X/Y/Z: M√∫ltiplos par√¢metros simult√¢neos

### 4. Board Som üìù (TEMPLATE)

**Descri√ß√£o**: Placa multi-sensor com diferentes tipos de entrada.

**Planejamento:**

- M√∫ltiplos sensores: Touch, pressure, proximity
- Mapeamento flex√≠vel de notas/par√¢metros
- Suporte a polifonia

### 5. Big KeyBoard üìù (TEMPLATE)

**Descri√ß√£o**: Teclado grande com 12 teclas.

**Planejamento:**

- 12 teclas: Escala crom√°tica completa
- Tamanho aumentado: Acessibilidade
- Velocity sensitiva

### 6. Musical Beam üìù (TEMPLATE)

**Descri√ß√£o**: Sensor de feixe infravermelho para controle por dist√¢ncia.

**Planejamento:**
 
- Detec√ß√£o de dist√¢ncia: Controle cont√≠nuo
- M√∫ltiplos feixes: Polifonia ou par√¢metros
- Modo laser harp

---

## ‚öôÔ∏è Instala√ß√£o e Configura√ß√£o

### Pr√©-requisitos

- Navegador com suporte a Web MIDI API:
  - Google Chrome 43+ ‚úÖ
  - Microsoft Edge 79+ ‚úÖ
  - Opera 30+ ‚úÖ
  - Safari 15+ (macOS) ‚úÖ
  - Firefox (via extens√£o) ‚ö†Ô∏è

- Dispositivo MIDI USB conectado

### Estrutura de Arquivos

```
js/
‚îú‚îÄ‚îÄ midi/
‚îÇ   ‚îú‚îÄ‚îÄ midiDeviceManager.js         # Core manager
‚îÇ   ‚îú‚îÄ‚îÄ midiAutoReconnect.js         # Reconex√£o autom√°tica
‚îÇ   ‚îú‚îÄ‚îÄ midiOscilloscope.js          # Visualizador
‚îÇ   ‚îú‚îÄ‚îÄ midiStatusPanel.js           # Painel de status
‚îÇ   ‚îî‚îÄ‚îÄ devices/
‚îÇ       ‚îú‚îÄ‚îÄ terraDevicesTemplates.js # Classe base TerraDevice + templates
‚îÇ       ‚îú‚îÄ‚îÄ boardBellaCatalog.js     # Cat√°logo dedicado do Board Bella
‚îÇ       ‚îú‚îÄ‚îÄ boardBellaDevice.js      # Handler Board Bella (MIDI/HID)
‚îÇ       ‚îú‚îÄ‚îÄ boardBellsDevice.js      # Handler Board Bells
‚îÇ       ‚îî‚îÄ‚îÄ midiTerraDevice.js       # Handler Midi-Terra

css/
‚îî‚îÄ‚îÄ midi-ui.css                      # Estilos do sistema MIDI

index.html                           # Importa√ß√£o de scripts
```

### Inclus√£o no HTML

**CSS:**
```html
<link rel="stylesheet" href="css/midi-ui.css">
```

**Scripts (ordem cr√≠tica):**

```html
<!-- Sistema MIDI -->
<script src="js/midi/midiDeviceManager.js"></script>
<script src="js/midi/midiAutoReconnect.js"></script>
<script src="js/midi/devices/boardBellsDevice.js"></script>
<script src="js/midi/devices/terraDevicesTemplates.js"></script>
<script src="js/midi/devices/boardBellaCatalog.js"></script>
<script src="js/midi/devices/boardBellaDevice.js"></script>
<script src="js/midi/devices/midiTerraDevice.js"></script>
<script src="js/midi/midiOscilloscope.js"></script>
<script src="js/midi/midiStatusPanel.js"></script>
```

**Elementos HTML:**
```html
<!-- Painel de Status -->
<div id="midi-status-panel"></div>

<!-- Oscilosc√≥pio -->
<div class="oscilloscope-container">
    <canvas id="midi-oscilloscope" width="800" height="200"></canvas>
</div>
```

### Inicializa√ß√£o no app.js

O sistema √© inicializado automaticamente ap√≥s o audioEngine e soundfontManager:

```javascript
// Inicializar sistema MIDI
if (window.MIDIDeviceManager && window.soundfontManager && window.audioEngine) {
    window.midiManager = new MIDIDeviceManager();
    window.midiManager.initialize().then(() => {
        // Configurar callbacks
        window.midiManager.onDeviceConnected = (device) => {
            window.midiStatusPanel?.addDevice(device);
        };
        
        window.midiManager.onDeviceDisconnected = (deviceId) => {
            window.midiStatusPanel?.removeDevice(deviceId);
        };
    });
}

// Inicializar painel e oscilosc√≥pio
window.midiStatusPanel = new MIDIStatusPanel('midi-status-panel');
window.midiOscilloscope = new MIDIOscilloscope('midi-oscilloscope');
```

---

## üéÆ Uso do Sistema

### Auto-detec√ß√£o de Dispositivos

1. **Conecte o dispositivo Terra via USB**
2. **Abra a aplica√ß√£o no navegador**
3. **Sistema detecta automaticamente** e exibe no painel

### Monitoramento em Tempo Real

**Painel de Status:**
- üü¢ **Dispositivos conectados**: Lista com √≠cones
- üéµ **Notas ativas**: Badges coloridos por nota
- üéº **Instrumento atual**: Nome e n√∫mero do programa
- üìä **Estat√≠sticas**: Total de notas tocadas

**Oscilosc√≥pio:**
- üìà **Forma de onda**: Hist√≥rico de pitch bend
- üéØ **Indicador de deadzone**: Zona amarela (¬±2%)
- üî¢ **Valores num√©ricos**: Percentual em tempo real
- üé® **Cores**: Verde = ativo, Cinza = deadzone

### Troca de Instrumentos (Board Bells)

**Via MIDI Program Change:**
1. Dispositivo envia Program Change (0-4)
2. Sistema mapeia para instrumento correspondente
3. soundfontManager carrega novo preset
4. Painel atualiza exibi√ß√£o

**Tabela de Programas:**
```
P0 ‚Üí Piano de Cauda
P1 ‚Üí Violino Ensemble
P2 ‚Üí Flauta Concerto
P3 ‚Üí Viol√£o Nylon
P4 ‚Üí Harpa Orquestral
```

### Pitch Bend com Deadzone

**Deadzone de 2%:**
- **Centro**: 8192 (0%)
- **Deadzone**: 8028 - 8356 (¬±2%)
- **Range completo**: 0 - 16383 (¬±100%)

**Comportamento:**
- Movimentos dentro da deadzone ‚Üí ignorados
- Movimentos fora da deadzone ‚Üí aplicados
- Reduz tremor e movimentos n√£o intencionais

---

## üîä Integra√ß√£o com Web Audio

### Fluxo de Reprodu√ß√£o

```
MIDI Device ‚Üí Note On Message
     ‚Üì
BoardBellsDevice.handleNoteOn()
     ‚Üì
soundfontManager.startSustainedNote(noteName, velocity)
     ‚Üì
WebAudioFontPlayer.queueWaveTable()
     ‚Üì
audioEngine.audioContext.destination
     ‚Üì
Alto-falantes üîä
```

### Integra√ß√£o com soundfontManager

**Board Bells ‚Üí soundfontManager:**

```javascript
// Note On
const normalizedVelocity = message.velocity / 127;
this.soundfontManager.startSustainedNote(noteName, normalizedVelocity);

// Note Off
this.soundfontManager.stopSustainedNote(message.note);

// Program Change
this.soundfontManager.loadInstrument(instrumentKey, {
    setCurrent: true,
    clearKit: false
});
```

### Passagem de Refer√™ncias

**No app.js:**

```javascript
// Dispositivos recebem refer√™ncias via setAudioIntegration
if (window.midiManager.connectedDevices) {
    window.midiManager.connectedDevices.forEach(device => {
        if (device.handler) {
            device.handler.setAudioIntegration(
                window.soundfontManager,
                window.audioEngine
            );
        }
    });
}
```

---

## üß™ Testes e Valida√ß√£o

### Testes com Board Bells

#### 1. Teste de Notas

**Objetivo**: Verificar mapeamento correto de notas.

**Procedimento:**
1. Conectar Board Bells via USB
2. Abrir Console do navegador (F12)
3. Tocar cada nota sequencialmente
4. Verificar logs no console:
   ```
   üéµ Board Bells: Note ON - C (MIDI 60) | Velocity: 64
   ‚úÖ √Åudio iniciado para C
   ```
5. Verificar painel mostra nota ativa
6. Soltar nota e verificar Note OFF:
   ```
   üéµ Board Bells: Note OFF - C (MIDI 60)
   ‚úÖ √Åudio parado para C
   ```

**Resultado Esperado:**
- ‚úÖ Todas as 8 notas reproduzem √°udio
- ‚úÖ Notas aparecem/desaparecem do painel
- ‚úÖ Sem erros no console

#### 2. Teste de Program Change

**Objetivo**: Validar troca de instrumentos.

**Procedimento:**
1. Com Board Bells conectado
2. Enviar Program Change 0-4 via dispositivo ou MIDI tool
3. Verificar console:
   ```
   üéº Board Bells: Program Change - 1
   üéπ Trocando para instrumento: violin_ensemble
   ‚úÖ Instrumento violin_ensemble carregado
   ```
4. Tocar nota e confirmar timbre mudou
5. Verificar painel mostra instrumento correto

**Resultado Esperado:**
- ‚úÖ Instrumento troca corretamente
- ‚úÖ Painel atualiza nome do instrumento
- ‚úÖ √Åudio usa novo preset

#### 3. Teste de Pitch Bend

**Objetivo**: Validar deadzone e visualiza√ß√£o.

**Procedimento:**
1. Abrir oscilosc√≥pio visual
2. Mover pitch bend wheel/slider sutilmente (< 2%)
3. Verificar:
   - Console N√ÉO mostra logs
   - Oscilosc√≥pio mostra linha cinza na deadzone
   - Valor efetivo permanece em 0%
4. Mover pitch bend > 2%
5. Verificar:
   ```
   üéöÔ∏è Board Bells: Pitch Bend - 5.23% (raw: 8620)
   ```
   - Oscilosc√≥pio mostra linha verde
   - Valor efetivo muda

**Resultado Esperado:**
- ‚úÖ Movimentos < 2% ignorados
- ‚úÖ Movimentos > 2% processados
- ‚úÖ Visualiza√ß√£o correta no oscilosc√≥pio

### Simula√ß√£o MIDI (Sem Hardware)

**Ferramenta Recomendada**: [MIDI-OX](http://www.midiox.com/) (Windows) ou [MIDI Monitor](https://www.snoize.com/MIDIMonitor/) (macOS)

**Criar dispositivo virtual:**

1. **Windows** (loopMIDI):
   - Instalar [loopMIDI](https://www.tobias-erichsen.de/software/loopmidi.html)
   - Criar porta virtual: "Terra Board Bells"
   - Enviar mensagens MIDI via MIDI-OX

2. **macOS** (IAC Driver):
   - Abrir Audio MIDI Setup
   - Habilitar IAC Driver
   - Criar porta: "Terra Board Bells"
   - Enviar via MIDI Monitor

**Mensagens de Teste:**

```
Note On:  90 3C 64  (Canal 1, Nota 60 (C4), Velocity 100)
Note Off: 80 3C 40  (Canal 1, Nota 60, Velocity 64)
Program:  C0 01     (Canal 1, Programa 1)
PitchBend: E0 00 50 (Canal 1, Valor 10240 = +25%)
```

---

## üõ†Ô∏è Desenvolvimento de Novos Dispositivos

### Template Base

Todos os dispositivos herdam de `TerraDevice`:

```javascript
class NovoDispositivo extends TerraDevice {
    constructor(midiInput, manager) {
        super(midiInput, manager);
        
        // Configura√ß√µes espec√≠ficas
        this.config = {
            // ... par√¢metros
        };
        
        // Estado espec√≠fico
        this.state = {
            // ... vari√°veis
        };
    }
    
    handleMessage(message) {
        // Processar mensagens MIDI
        switch (message.type) {
            case 'noteOn':
                this.handleNoteOn(message);
                break;
            // ...
        }
    }
    
    handleNoteOn(message) {
        // L√≥gica espec√≠fica
    }
    
    // Outros handlers...
}
```

### Checklist de Implementa√ß√£o

#### 1. Criar Classe do Dispositivo

- [ ] Estender `TerraDevice`
- [ ] Definir `config` com par√¢metros
- [ ] Inicializar `state` com vari√°veis
- [ ] Implementar `handleMessage()`
- [ ] Criar handlers para cada tipo de mensagem

#### 2. Mapeamento MIDI

- [ ] Definir notas/par√¢metros MIDI
- [ ] Criar tabela de mapeamento
- [ ] Documentar ranges e escalas

#### 3. Integra√ß√£o com √Åudio

- [ ] Implementar `setAudioIntegration()`
- [ ] Chamar `soundfontManager.startSustainedNote()`
- [ ] Chamar `soundfontManager.stopSustainedNote()`
- [ ] (Opcional) Carregar instrumentos via `loadInstrument()`

#### 4. Integra√ß√£o com UI

- [ ] Atualizar `window.midiStatusPanel` (notas ativas)
- [ ] (Opcional) Atualizar oscilosc√≥pio ou visualizador customizado
- [ ] Callbacks customizados (onNoteOn, onProgramChange, etc.)

#### 5. Registro no Manager

Adicionar no `createDeviceHandler()` de `midiDeviceManager.js`:

```javascript
createDeviceHandler(input) {
    const deviceName = input.name.toLowerCase();
    
    if (deviceName.includes('novo dispositivo')) {
        console.log('‚úÖ Criando handler para Novo Dispositivo');
        const handler = new NovoDispositivo(input, this);
        handler.setAudioIntegration(this.soundfontManager, this.audioEngine);
        return handler;
    }
    
    // ...
}
```

#### 6. Testes

- [ ] Conectar dispositivo f√≠sico
- [ ] Verificar auto-detec√ß√£o
- [ ] Testar todas as mensagens MIDI
- [ ] Validar reprodu√ß√£o de √°udio
- [ ] Confirmar atualiza√ß√£o de UI
- [ ] Documentar comportamento

### Exemplo Completo: Giro Som

```javascript
class GiroSomDevice extends TerraDevice {
    constructor(midiInput, manager) {
        super(midiInput, manager);
        
        this.config = {
            name: 'Giro Som',
            rotationCC: 1,  // CC#1 para rota√ß√£o
            speedCC: 2,     // CC#2 para velocidade
        };
        
        this.state = {
            rotation: 0,
            speed: 0,
            isActive: false
        };
    }
    
    handleMessage(message) {
        if (message.type === 'controlChange') {
            this.handleControlChange(message);
        }
    }
    
    handleControlChange(message) {
        if (message.controller === this.config.rotationCC) {
            this.state.rotation = message.value;
            this.updateRotation();
        } else if (message.controller === this.config.speedCC) {
            this.state.speed = message.value;
            this.updateSpeed();
        }
    }
    
    updateRotation() {
        const angle = (this.state.rotation / 127) * 360;
        console.log(`üåÄ Giro Som: Rota√ß√£o ${angle.toFixed(1)}¬∞`);
        
        // Mapear rota√ß√£o para par√¢metro musical
        // Exemplo: controlar panning
        if (this.audioEngine) {
            const panValue = (this.state.rotation / 127) * 2 - 1; // -1 a +1
            // this.audioEngine.setPan(panValue);
        }
    }
    
    updateSpeed() {
        const velocity = this.state.speed / 127;
        console.log(`üí® Giro Som: Velocidade ${(velocity * 100).toFixed(1)}%`);
        
        // Mapear velocidade para intensidade
        // Exemplo: controlar volume ou efeitos
    }
}
```

---

## üêõ Troubleshooting

### Dispositivo N√£o Detectado

**Sintoma**: Board Bells conectado mas n√£o aparece no painel.

**Diagn√≥stico:**
1. Verificar se navegador suporta Web MIDI API:
   ```javascript
   if (navigator.requestMIDIAccess) {
       console.log('‚úÖ Web MIDI API suportada');
   } else {
       console.log('‚ùå Web MIDI API N√ÉO suportada');
   }
   ```

2. Verificar permiss√µes MIDI (Chrome requer permiss√£o expl√≠cita)

3. Inspecionar dispositivos detectados:
   ```javascript
   window.midiManager.connectedDevices.forEach(device => {
       console.log(device.name, device.id);
   });
   ```

**Solu√ß√µes:**
- ‚úÖ Usar navegador compat√≠vel (Chrome, Edge)
- ‚úÖ Conceder permiss√£o MIDI quando solicitado
- ‚úÖ Reconectar dispositivo USB
- ‚úÖ Verificar nome do dispositivo cont√©m "board bells" (case-insensitive)

### √Åudio N√£o Reproduz

**Sintoma**: Notas aparecem no painel mas n√£o h√° som.

**Diagn√≥stico:**
1. Verificar soundfontManager iniciado:
   ```javascript
   console.log(window.soundfontManager);
   ```

2. Verificar audioContext desbloqueado:
   ```javascript
   console.log(window.audioEngine.audioContext.state);
   // Deve ser 'running', n√£o 'suspended'
   ```

3. Verificar preset carregado:
   ```javascript
   console.log(window.soundfontManager.currentPreset);
   ```

**Solu√ß√µes:**
- ‚úÖ Clicar em qualquer lugar da p√°gina para desbloquear √°udio
- ‚úÖ Aguardar carregamento completo dos presets
- ‚úÖ Verificar volume do sistema operacional
- ‚úÖ Trocar instrumento via Program Change

### Pitch Bend N√£o Funciona

**Sintoma**: Movimentos de pitch bend n√£o t√™m efeito.

**Diagn√≥stico:**
1. Verificar mensagens recebidas:
   ```javascript
   window.debugMode = true; // Habilitar logs
   ```

2. Verificar oscilosc√≥pio atualiza:
   ```javascript
   console.log(window.midiOscilloscope.getStats());
   ```

**Solu√ß√µes:**
- ‚úÖ Mover pitch bend > 2% (fora da deadzone)
- ‚úÖ Verificar se dispositivo envia mensagens Pitch Bend (0xE0)
- ‚úÖ Conferir se oscilosc√≥pio foi inicializado

### Console Cheio de Warnings

**Sintoma**: Muitos warnings de "nota n√£o mapeada" ou similares.

**Diagn√≥stico:**
1. Verificar range de notas MIDI enviadas:
   ```javascript
   // Board Bells espera notas 60-72
   ```

2. Conferir se dispositivo est√° enviando messages inesperadas

**Solu√ß√µes:**
- ‚úÖ Ajustar mapeamento de notas no handler
- ‚úÖ Filtrar mensagens n√£o suportadas
- ‚úÖ Adicionar suporte para novas mensagens

---

## üìö Refer√™ncias

### Web MIDI API
- [MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/API/Web_MIDI_API)
- [W3C Specification](https://www.w3.org/TR/webmidi/)

### MIDI Protocol
- [MIDI 1.0 Specification](https://www.midi.org/specifications/midi-1-0)
- [MIDI Message Types](https://www.midi.org/specifications-old/item/table-1-summary-of-midi-message)

### Web Audio API
- [MDN Web Audio API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
- [Web Audio Specification](https://www.w3.org/TR/webaudio/)

---

## üìù Notas de Vers√£o

### v1.0.0 (16/10/2025)

**Implementado:**
- ‚úÖ MIDIDeviceManager com auto-detec√ß√£o
- ‚úÖ BoardBellsDevice completo
- ‚úÖ Templates para 4 dispositivos futuros
- ‚úÖ MIDIOscilloscope com deadzone visual
- ‚úÖ MIDIStatusPanel com UI completa
- ‚úÖ Integra√ß√£o com soundfontManager e audioEngine
- ‚úÖ CSS moderno com dark theme
- ‚úÖ Documenta√ß√£o completa

**Pr√≥ximos Passos:**
- üìù Implementar GiroSomDevice
- üìù Implementar BoardSomDevice
- üìù Implementar BigKeyBoardDevice
- üìù Implementar MusicalBeamDevice
- üìù Adicionar suporte a MIDI 2.0
- üìù Implementar grava√ß√£o de sess√µes MIDI

---

## ü§ù Contribuindo

Para adicionar suporte a novos dispositivos Terra:

1. **Clone o template** de `terraDevicesTemplates.js`
2. **Implemente os handlers** de mensagens MIDI
3. **Teste com dispositivo f√≠sico**
4. **Documente** mapeamento e caracter√≠sticas
5. **Adicione ao manager** em `createDeviceHandler()`

---

## üìß Suporte

Para quest√µes e suporte t√©cnico:
- **GitHub Issues**: [reposit√≥rio do projeto]
- **Email**: suporte@terraeletronica.com.br
- **Documenta√ß√£o**: Este arquivo

---

**Desenvolvido com ‚ù§Ô∏è para MusicoTerapia AI**  
Terra Eletr√¥nica ¬© 2025
